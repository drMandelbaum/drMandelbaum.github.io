<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CryptoPlates</title>

    <style>

        @import url('https://fonts.googleapis.com/css2?family=Syne+Mono&display=swap');

        #test_holder {
            padding: 40px;
        }

        .plate {
            font-family: 'Syne Mono', monospace;
            width: 1000px;
            background: rebeccapurple;

        }

        .plate_info {
            height: 100px;
        }

        .plate_pressed_by {
            height: 60px;
        }

        .plate_pressed_by_icon {
            position: absolute;
            margin-top: 0px;
            margin-left: 8px;
        }

        .plate_pressed_by_label {
            font-size: medium;
            position: absolute;
            margin-left: 68px;
            margin-top: 4px;
            color: #ccc;
        }

        .plate_pressed_by_address {
            font-size: large;
            position: absolute;
            margin-left: 68px;
            margin-top: 20px;
            color: white;
        }

        .plate_pressed_by_address:hover {
            background: white;
            color: black;
        }

        .plate_icon {
            position: absolute;
            margin-top: 8px;
            margin-left: 8px;
        }

        .plate_name {
            font-size: xx-large;
            position: absolute;
            margin-left: 102px;
            margin-top: 8px;
            color: white;
        }

        .plate_address {
            font-size: larger;
            position: absolute;
            margin-left: 102px;
            margin-top: 44px;
            color: white;
            text-decoration: none;
        }

        .plate_address:hover {
            background: white;
            color: black;
        }

        .plate_pressed_at {
            font-size: larger;
            position: absolute;
            margin-left: 102px;
            margin-top: 64px;
            color: #ccc;
        }

    </style>

</head>

<body>


<img src="./cryptoplates.png">
<br>
<div id="test_holder"></div>


<script type="text/javascript">

    var web3;

    async function loadWeb3() {
        web3 = new Web3(window.ethereum);
        window.ethereum.enable();
    }

    function createPlateContract(adress) {
        return new web3.eth.Contract([
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "_pressedBy",
                            "type": "address"
                        },
                        {
                            "internalType": "uint256",
                            "name": "_totalSupply",
                            "type": "uint256"
                        },
                        {
                            "internalType": "string",
                            "name": "_name",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_data",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "owner",
                            "type": "address"
                        },
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "spender",
                            "type": "address"
                        },
                        {
                            "indexed": false,
                            "internalType": "uint256",
                            "name": "value",
                            "type": "uint256"
                        }
                    ],
                    "name": "Approval",
                    "type": "event"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "from",
                            "type": "address"
                        },
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "to",
                            "type": "address"
                        },
                        {
                            "indexed": false,
                            "internalType": "uint256",
                            "name": "value",
                            "type": "uint256"
                        }
                    ],
                    "name": "Transfer",
                    "type": "event"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "owner",
                            "type": "address"
                        },
                        {
                            "internalType": "address",
                            "name": "delegate",
                            "type": "address"
                        }
                    ],
                    "name": "allowance",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "delegate",
                            "type": "address"
                        },
                        {
                            "internalType": "uint256",
                            "name": "numTokens",
                            "type": "uint256"
                        }
                    ],
                    "name": "approve",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "tokenOwner",
                            "type": "address"
                        }
                    ],
                    "name": "balanceOf",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "data",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "decimals",
                    "outputs": [
                        {
                            "internalType": "uint8",
                            "name": "",
                            "type": "uint8"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "name",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "pressedAt",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "pressedBy",
                    "outputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "symbol",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "totalSupply",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "receiver",
                            "type": "address"
                        },
                        {
                            "internalType": "uint256",
                            "name": "numTokens",
                            "type": "uint256"
                        }
                    ],
                    "name": "transfer",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "owner",
                            "type": "address"
                        },
                        {
                            "internalType": "address",
                            "name": "buyer",
                            "type": "address"
                        },
                        {
                            "internalType": "uint256",
                            "name": "numTokens",
                            "type": "uint256"
                        }
                    ],
                    "name": "transferFrom",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "function"
                }
            ],
            adress
        );
    }

    async function firstAccount() {
        let accounts = await window.web3.eth.getAccounts()
        return accounts[0]
    }

    async function load() {
        await loadWeb3()
        document.getElementById("test_holder").appendChild(await renderPlate("0x92F04f19f4e1971D3525B7eD7AA5Ca58CC6480e8"))
    }

    async function renderPlate(address) {
        let contract = createPlateContract(address)
        let pressedBy = await contract.methods.pressedBy().call()
        let pressedAt = await contract.methods.pressedAt().call()
        let name = await contract.methods.name().call()
        let data = await contract.methods.data().call()


        let mainElement = document.createElement("div")
        mainElement.setAttribute("class", "plate")


        // INFO ELEMENT
        let infoElement = document.createElement("div")
        infoElement.setAttribute("class", "plate_info")

        let plateIcon = blockies.create({
            seed: address,
            size: 10,
            scale: 8,
            spotcolor: -1
        });
        plateIcon.setAttribute("class", "plate_icon")

        let nameParagraph = document.createElement("p")
        nameParagraph.setAttribute("class", "plate_name")
        nameParagraph.textContent = name;

        let plateAddressParagraph = document.createElement("a")
        plateAddressParagraph.setAttribute("class", "plate_address")
        plateAddressParagraph.setAttribute("href", "https://ropsten.etherscan.io/address/" + address)
        plateAddressParagraph.setAttribute("target", "blank")
        plateAddressParagraph.textContent = address

        let pressedAtParagraph = document.createElement("p")
        pressedAtParagraph.setAttribute("class", "plate_pressed_at")
        pressedAtParagraph.textContent = "pressed at: " + pressedAt;

        infoElement.appendChild(plateIcon)
        infoElement.appendChild(nameParagraph)
        infoElement.appendChild(plateAddressParagraph)
        infoElement.appendChild(pressedAtParagraph)


        // PRESSED BY ELEMENT

        let pressedByElement = document.createElement("div")
        pressedByElement.setAttribute("class", "plate_pressed_by")

        let pressedByIcon = blockies.create({
            seed: pressedBy,
            size: 10,
            scale: 5,
            spotcolor: -1
        });
        pressedByIcon.setAttribute("class", "plate_pressed_by_icon")

        let pressedByLabelParagraph = document.createElement("p")
        pressedByLabelParagraph.setAttribute("class", "plate_pressed_by_label")
        pressedByLabelParagraph.textContent = "pressed by:";

        let pressedByAddressParagraph = document.createElement("a")
        pressedByAddressParagraph.setAttribute("class", "plate_pressed_by_address")
        pressedByAddressParagraph.setAttribute("href", "https://ropsten.etherscan.io/address/" + pressedBy)
        pressedByAddressParagraph.setAttribute("target", "blank")
        pressedByAddressParagraph.textContent = pressedBy;

        pressedByElement.appendChild(pressedByIcon)
        pressedByElement.appendChild(pressedByLabelParagraph)
        pressedByElement.appendChild(pressedByAddressParagraph)


        // CONTENT ELEMENT
        let dom = new DOMParser().parseFromString(data, "text/html")
        let dataElement = dom.body.firstElementChild


        // FINALIZE
        mainElement.appendChild(infoElement)
        mainElement.appendChild(pressedByElement)
        mainElement.appendChild(dataElement)
        return mainElement
    }



    async function loadImage(key) {
        let result = await contract.methods.dataMap(key).call()
        let imagesContainer = document.getElementById("images")
        let image = document.createElement('img')
        image.setAttribute('src',result.data)
        imagesContainer.appendChild(image)
    }

    async function saveData(key, data) {
        await contract.methods.save(key, data).send({from: await firstAccount()})
    }

    async function onLoadClicked() {
        await loadImage(document.getElementById("key_input").value)
    }

    async function onSaveClicked() {
        await saveData(
            document.getElementById("key_input").value,
            document.getElementById("data_input").value
        )
    }

</script>

<script src="./blockies.min.js" onload="load()"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js" onload="load()"></script>


</body>
</html>